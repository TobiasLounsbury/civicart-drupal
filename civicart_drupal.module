<?php

function civicart_drupal_token_info() {

  if(!civicrm_initialize()) {
    return;
  }

  $info['types']['civicart'] = array(
    'name' => t('CiviCart'),
    'description' => t('Tokens for use with the CiviCRM Shopping Cart.'),
  );

  /*
  $info['tokens']['civicart']['example'] = array(
    'name' => t('Example Token Title'),
    'description' => t('Example CiviCRM Shopping Cart Token Description'),
  );
  */

  $items = CRM_Civicart_Tokens::getCartItems();
  $types = array(
    "full" => "Adds item description and 'Add to Cart' buttons for %NAME%",
    "button" => "Adds 'Add to Cart' buttons for %NAME%",
    "description" => "Adds item description for %NAME%"
  );

  foreach($items as $item) {
    foreach($types as $type => $typeDescription) {

      $info['tokens']['civicart']["item:{$item['id']}:{$type}:{$item['name']}"] = array(
        'name' => "{$item['label']} - {$type}",
        'description' => str_replace("%NAME%", $item['label'], $typeDescription),
      );

      //todo: Handle individual checkbox items

    }
  }

  return $info;
}

function civicart_drupal_tokens($type, $tokens, array $data = array(), array $options = array()) {
  $replacements = array();

  if(!civicrm_initialize()) {
    return $replacements;
  }


  if ($type == 'civicart') {
    foreach($tokens as $parsed => $fullToken) {

      //[civicart:item:5:full]
      //[civicart:option:25:full]

      $item = false;
      $option = false;

      //Parse the token
      $parts = explode(":", $parsed);

      //Set the Item
      if($parts[0] == "item") {
        $item = $parts[1];
      }

      //Set the Option Number
      if($parts[0] == "option") {
        $option = $parts[1];
      }

      //Delegate content generation to civi functions
      $replacements[$fullToken] = CRM_Civicart_Tokens::getItemContent($item, $option, $parts[2]);
    }
  }

  return $replacements;
}